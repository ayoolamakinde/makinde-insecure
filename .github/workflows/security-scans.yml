name: Security Scans

on:
  push:
    branches:
      - master
      - develop
  pull_request:
    branches:
      - master
      - develop
  workflow_dispatch:

permissions:
  id-token: write
  contents: read
  pull-requests: write
  issues: write
  security-events: write


jobs:
  sca-scan:
    name: SCA - Dependency Vulnerabilities
    uses: ayoolamakinde/appsec-static-scanner/.github/workflows/sca-scan.yml@master
    with:
      severity: 'CRITICAL,HIGH,MEDIUM,LOW'
      fail_on_severity: 'HIGH'
      generate_sbom: true
      output_format: 'json'
      create_issue: true
      comment_pr: true
    secrets:
      SECURITY_WEBHOOK: ${{ secrets.SLACK_WEBHOOK }}

  sast-scan:
    name: SAST - Code Vulnerabilities
    uses: ayoolamakinde/appsec-static-scanner/.github/workflows/sast-scan.yml@master
    with:
      languages: 'python,javascript,typescript,go,java'
      rules_path: 'p/owasp-top-ten,p/security-audit'
      fail_on_severity: 'ERROR'
      upload_sarif: true
      create_issue: true
      comment_pr: true
    secrets:
      SECURITY_WEBHOOK: ${{ secrets.SLACK_WEBHOOK }}

  iac-scan:
    name: IAC - Infrastructure Misconfigurations
    uses: ayoolamakinde/appsec-static-scanner/.github/workflows/iac-scan.yml@master
    with:
      frameworks: 'terraform,kubernetes,dockerfile,cloudformation,bicep'
      fail_on_severity: 'HIGH'
      download_external_modules: true
      compact_output: false
      create_issue: true
      comment_pr: true
    secrets:
      SECURITY_WEBHOOK: ${{ secrets.SLACK_WEBHOOK }}

  secrets-scan:
    name: Secrets - Exposed Credentials
    uses: ayoolamakinde/appsec-static-scanner/.github/workflows/secrets-scan.yml@master
    with:
      scan_type: 'filesystem,git'
      scan_history: true
      only_verified: false
      entropy_threshold: 3.0
      fail_on_finding: false
      create_issue: true
      comment_pr: true
    secrets:
      SECURITY_WEBHOOK: ${{ secrets.SLACK_WEBHOOK }}

  summary:
    name: Security Scan Summary
    needs: [sca-scan, sast-scan, iac-scan, secrets-scan]
    runs-on: ubuntu-latest
    if: always()
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Generate Summary
        run: |
          echo "# Security Scan Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "## Scan Results" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Scan Type | Status |" >> $GITHUB_STEP_SUMMARY
          echo "|-----------|--------|" >> $GITHUB_STEP_SUMMARY
          echo "| SCA (Dependencies) | ${{ needs.sca-scan.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "| SAST (Code) | ${{ needs.sast-scan.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "| IAC (Infrastructure) | ${{ needs.iac-scan.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Secrets | ${{ needs.secrets-scan.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "âš ï¸ **Note**: This repository contains intentionally vulnerable code for testing purposes." >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "Expected behavior: Multiple security findings should be detected across all scan types." >> $GITHUB_STEP_SUMMARY

      - name: Notify Final Status
        if: always()
        run: |
          curl -X POST ${{ secrets.SLACK_WEBHOOK }} \
            -H 'Content-Type: application/json' \
            -d '{
              "text": "ðŸ”’ Security Scan Complete",
              "blocks": [
                {
                  "type": "header",
                  "text": {
                    "type": "plain_text",
                    "text": "Security Scan Summary"
                  }
                },
                {
                  "type": "section",
                  "text": {
                    "type": "mrkdwn",
                    "text": "Repository: ${{ github.repository }}\nBranch: ${{ github.ref_name }}\nCommit: ${{ github.sha }}\n\n*Results:*\nSCA: ${{ needs.sca-scan.result }}\nSAST: ${{ needs.sast-scan.result }}\nIAC: ${{ needs.iac-scan.result }}\nSecrets: ${{ needs.secrets-scan.result }}"
                  }
                }
              ]
            }'
